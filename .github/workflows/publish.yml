name: build-and-publish

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/quicstar

jobs:
  publish-wheel:
    name: Build & Upload Wheel
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: false

      - name: Build wheel
        run: poetry build -f wheel

      - name: Publish to package index
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
          TWINE_REPOSITORY_URL: ${{ vars.PYPI_REPOSITORY_URL || 'https://git.diath.systems/api/packages/diamantth/pypi' }}
        run: |
          python -m pip install --upgrade pip twine
          twine upload --non-interactive --repository-url "$TWINE_REPOSITORY_URL" dist/*.whl

  publish-container:
    name: Build & Push Container
    runs-on: ubuntu-latest
    needs: publish-wheel
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Read project version
        id: project_version
        run: |
          python - <<'PY'
          import os
          import pathlib
          import tomllib

          version = tomllib.loads(pathlib.Path("pyproject.toml").read_text())["tool"]["poetry"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as gh_out:
              gh_out.write(f"version={version}\n")
          PY

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.project_version.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest
